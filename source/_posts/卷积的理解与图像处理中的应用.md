title: 卷积的理解与图像处理中的应用
date: 2015-11-17 21:32:28
tags:
- 卷积
- 计算机视觉
categories: 
- 理论
mathjax: true 
---
对卷积内容的一些学习和整理，从基本的图像滤波到CNN，供备忘和交流，个别图借用了自动化所董老师的课件。

##一、卷积
###1. 定义：
定义一种卷积运算，将两个函数$g(x)$与$f(x)$通过该运算得到$h(x)$
- 卷积有多重解释。泛函中解释为两个函数生成第三个函数的数学算子；概率论解释为两变量叠加的概率密度等，这些解释的特点是两个卷积函数地位是相同的，对应$(f\otimes g) (x) = (g\otimes f) (x)$，具体也有推导，我们不详细研究。
- 这里主要从图像处理和信号方面理解，所以区分原函数与响应函数会比较直观。

###2. 公式：
假设$f(x)$为原函数，$g(x)$为卷积函数，$h(x)$为卷积运算后新生成的函数；
注意：积分和累加的范围实际是卷积函数$g(x)$的定义域。
{% raw %}
- 一维连续： 
$$
h(x) = \int g(\tau)f(x-\tau)d\tau
$$
- 一维离散：
$$
h(x) = \sum_\tau g(\tau)f(x-\tau)
$$
{% endraw %}
- 从公式理解：
	- 无限多的离散点就构成了连续，两公式所含意义相同，大多问题是连续存在的。注意这里从卷积函数$g(x)$却别离散与连续。
	- 从公式角度谈一下$\tau$。卷积可以理解为**对冲击响应的持续叠加**。现在我们求的是$h(x)$的值，这一点的值由所有这点之前和之后的值对这点的影响叠加而成。把$x$理解成时间维度，这里$f(x-\tau)$定位到$x$点之前$\tau$的时间，$g(\tau)$表示该时间的卷积函数对x点影响，积分或叠加所有这些影响，得到$h(x)$的值。（形象理解可以看图下面引的例子）

###3.函数图像：
四幅图对照下文，分别解释了离散和连续情况的卷积运算,后三幅图的三个函数图像分别为原函数$f(x)$，卷积响应函数$g(x)$，和最终卷积运算的结果$h(x)$。
其中图1直接取自百度，图2-4是用matplotlib绘成，使用离散点模拟的连续函数。
<table border="1" align="center"><span style="font-size:24px;color:#006600;"></span><caption align="top">函数图像</caption>  
<tr><td>图一<img src="http://7xjz3b.com1.z0.glb.clouddn.com/juanji1.jpg" width = "300" height = "200" alt="" align=center /></td> <td>图2<img src="http://7xjz3b.com1.z0.glb.clouddn.com/figure_3.png" width = "300" height = "200" alt="" align=center /></td> </tr>
<tr><td>图3<img src="http://7xjz3b.com1.z0.glb.clouddn.com/figure_1.png" width = "300" height = "200" alt="" align=center /></td> <td>图4<img src="http://7xjz3b.com1.z0.glb.clouddn.com/figure_2.png" width = "300" height = "200" alt="" align=center /></td> </tr>
</table>  

####图像解释：
对卷积的理解很多，比较有直观的有[打拳](http://www.zhihu.com/question/22298352)、[向水中投石](http://www.zhihu.com/question/20500497)这两个例子。这些例子有几个共同的特点：
- 都有一个单位刺激的响应函数。如打一拳引起的疼痛，投一个石头引起的水花；
- 若力度相同（或是石头重量一致），原函数都是$f(x)=1$。把时间推移理解为横轴X；如果拳头的力量或是石头的大小有改变，则原函数$f(x)$变为图4中有波动的原函数。
- 例子中每个时间点观察的结果都是前面所有时间单位响应到目前结果的叠加，与卷积运算得出新函数的意义相同。
- 都是以离散点举例，最后想象无限多个点，进而演变成连续的解释。

结合函数图像来理解，离散的情况如**图1**，连续情况如**图2,3,4**。在**图2**中，$g(x)$单位高斯函数，在原函数$f(x)$的上的卷积运算.
用引用的帖子中总结概括：**各个时间点上的单位响应的加权叠加**。这里的加权，就是指的原函数$f(x)$中的函数值。

###4. 总结：
- 理解$X$轴为时间尺度，如果原函数是$f(x)$，响应函数$g(x)$是（0，1）这个点，那么卷积计算结果$h(x) = g(x) \otimes f(x)$的卷积结果是原函数$f(x)$。这是因为响应函数只存在于一点，所以，不会对后面的时间有影响，所以不存在随x轴的叠加————**证明了叠加性**（图2）
- 如果原函数$f(x)$是一个常数函数，那么无论响应函数形式如何，最后的卷积结果$h(x)$一定会趋向不变。这是因为原函数值不变，权值相同，时间尺度上的叠加都相同，所以函数值稳定后会不变———**证明了加权性**（图3）。

总结:
**一维卷积运算可以理解成以原函数值$f(x)$为尺度，以响应函数$g(x)$为单位，在$x$轴方向上的的叠加。**
###5. 卷积运算特性
####1. $\frac{\partial}{\partial{x}}(h\otimes{f}) = (\frac{\partial}{\partial{x}}h)\otimes{}f$
证明：
$$
\frac{d}{dt}[h(t)\otimes f(t)] = \frac{d}{dt}\int{f(\tau)h(t-\tau)}d\tau = \int{f(\tau)\frac{d}{dt}h(t-\tau)d\tau} = f(t)\otimes \frac{d}{dt}h(t)
$$
这个特性可以简化图像处理的运算，将多个步骤融合成一个卷积模板，比如LOG，如下图示意。
<table border="1" align="center"><span style="font-size:24px;color:#006600;"></span>  
<caption align="top"></caption>  
<tr><td><img src="http://7xjz3b.com1.z0.glb.clouddn.com/juanji6.jpg" width = "600" height = "300" alt="" align=center /></td> <td><img src="http://7xjz3b.com1.z0.glb.clouddn.com/juanji7.jpg" width = "600" height = "300" alt="" align=center /></td> </tr>
</table>  

##二、图像处理的卷积：
简单谈谈图像卷积应用中的自己的理解。
在图像中，卷积的使用方式主要是卷积核，也就是一个卷积模板。原始的图像是一个2D数字信号，应用一个2D卷积模板，可以看做原始图像每个像素与固定长宽的卷积模板做卷积运算，相当于对图像进行一次滤波。
{% raw %}
$$
G(x,y) \otimes I(x,y) = \sum_{u=-M}^M \sum_{v=-N}^N G(u,v)I(x-u,y-v)
$$
其中$I(x,y)$代表图像中每一个像素，$G(u,v)$表示尺寸为(2M+1)*(2N+1)的模板
{% endraw %}
![](http://7xjz3b.com1.z0.glb.clouddn.com/juanji5.jpg)
###关于卷积核

####1. 卷积函数与卷积核：
1. 卷积的定义是基于函数的，原始的卷积核模板上所有位置都对应同一个函数。
2. 实际使用中，我们常使用是某一函数的近似模板，模板上每个位置都有一个常数值。这种模板主要体现形状近似于卷积函数，计算也较为方便。


####2. 模板的特点
- 模板大小：一般卷积近似模板都是奇数个，如{% raw %}$3*3,5*5${% endraw %}等，这样每个模板有一个中心点，也有半径，大小的区别在于**对于单点被模板考虑的像素数的多少**。
- 模板上所有元素的加和：
	- 模板上所有元素（即卷积矩阵）的加和不同决定了模板的作用。当加和为1时，卷积计算前后图像的亮度不变。	
	- 检测边缘的卷积模板的加和往往为0，因为这些模板只是为了检测边缘，只关注像素之间的梯度关系，与像素值无关，无需原来像素点的像素。应用的结果是图像的亮度变得很暗。
- 这些卷积模板是对连续卷积核函数的数字采样近似，相当于上面用离散点近似连续卷积函数。不同的卷积模板决定了卷积的不同功能：去噪，平滑，凸显某些特征等，不详细叙述。


####3. 卷积运算的一种加速思想
{% raw %}
形如高斯核函数,$\sigma$为窗宽，决定平滑尺度：
$$
G_\sigma(x,y) = \frac{1}{\sqrt{2\pi\sigma^2}}exp(-\frac{x^2+y^2}{2\sigma^2})
$$
忽略规范化系数$\sqrt{2\pi\sigma^2}$：
$$
G_\sigma(x,y) = exp(\frac{-x^2}{2\sigma^2})exp(\frac{-y^2}{2\sigma^2})
$$
通过(2M+1)*(2N+1)的模板g(x,y)应用到图像中：
$$
\begin{align*}
g(x,y)\otimes I(x,y) &=\sum_{u=-M}^M \sum_{v=-N}^N g(u,v)I(x-u,y-v)\\&= \sum_{u=-M}^M \sum_{v=-N}^N exp(\frac{-u^2}{2\sigma^2})exp(\frac{-v^2}{2\sigma^2})I(x-u,y-v)\\
&=\sum_{u=-M}^M exp(\frac{-u^2}{2\sigma^2})[\sum_{v=-N}^Nexp(\frac{-v^2}{2\sigma^2})I(x-u,y-v)]
\end{align*}
$$

通过公式可以看出，假设原始图像大小为$A*B$, 模板大小为$M*N$，正常需要计算$A*B*M*N$次，现在转化为计算 $(M+N)*A*B $次，大大减小了运算时间。
{% endraw %}
如图:
![](http://7xjz3b.com1.z0.glb.clouddn.com/juanji8.jpg)
##End.

对知识的理解上，国内的知乎值得一看，看法往往独到且深入。不过有时百度百科、各种博客等大众性解释有很大的导性，看来普及性和质量往往难以共存。


Robin
November 11, 2015 10:57 PM    初写
January 7, 2016 9:56 PM   修改卷积公式描述，补充卷积性质
January 13, 2016 10:08 AM 增加卷积模板的加速运算。
February 22, 2016 3:07 PM 补充图像卷积核的一些特点。

